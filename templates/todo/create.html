{% extends "base.html" %}

{% load static %}

{% block content %}
<div class="container">
	<h2>Create a New Todo</h2>
		<div>
			<label for="name">Name:</label>
			<input type="text" name="name" id="name">
		</div>
		<div>
			<label for="description">Description:</label>
			<textarea name="description" id="description"></textarea>
		</div>
		<div>
			<label for="complete">Complete:</label>
			<input type="checkbox" name="complete" id="complete">
		</div>
    <div style="display: none;">
			<label for="completed_at">Completed At:</label>
      <input type="datetime-local" name="completed_at" id="completed_at">
		</div>
    <div>
      <label for="image">Images:</label>
      <input type="file" name="image" id="image">
	  </div>
		<div>
			<label for="exp">Experience Points:</label>
			<input type="number" name="exp" id="exp" min="0">
		</div>
		<button type="submit" id="todoCreate">Create</button>
</div>



<script>
// 1. ë¬¸ì„œê°€ ì™„ì „íˆ ë¡œë“œë˜ë©´ ì´ˆê¸°í™” ì‹¤í–‰ 
document.addEventListener('DOMContentLoaded', init);

// 2. UI ì´ë²¤íŠ¸
function init() {
  bindUIEvents(); // ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°
}

// 3. UI ì´ë²¤íŠ¸ ë°”ì¸ë”©
// í´ë¦­, ìŠ¤í¬ë¡¤, íƒ­í‚¤ ... ë¬¸ì„œë¡œë”©...
function bindUIEvents() {
  const btn = document.getElementById('todoCreate');
  if (!btn) return;
  btn.addEventListener('click', onCreateClick); // í´ë¦­ ì‹œ 4ë²ˆ ì‹¤í–‰
}

// ë°ì´í„° ìˆ˜ì§‘ ë° ì „ì†¡
function onCreateClick() {
  //ë°ì´í„°ë¥¼ í¼ìœ¼ë¡œ ë¶€í„° ìˆ˜ì§‘
  const payload = gatherFormData(); 
  console.log(" payload  :", payload);
  //ì„œë²„ì— ì „ì†¡
  createTodo(payload); 
}

//  6. API í˜¸ì¶œ: Todo ìƒì„± ìš”ì²­
function createTodo(data) {
  axiosInstance
    .post(`${TODO_API_CREATE_URL}`, data)
    .then(onCreateSuccess) // 7ë²ˆ: ì„±ê³µ ì‹œ ì²˜ë¦¬
    .catch(onCreateError); // 8ë²ˆ: ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
}

//  7. ìƒì„± ì„±ê³µ í•¸ë“¤ëŸ¬: ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™ 
function onCreateSuccess(response) {
  // ìƒì„± í›„ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
  window.location.href = '/todo/list/';
}


// --- 8. ìƒì„± ì‹¤íŒ¨ í•¸ë“¤ëŸ¬: ì—ëŸ¬ ì•Œë¦¼ --------------------------------------
function onCreateError(error) {
  console.log("ğŸ”¥ ì˜¤ë¥˜ ìƒì„¸:", error.response?.data || error);
  console.error('Todo ìƒì„± ì‹¤íŒ¨:', error);
  alert('Todo ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
}


function gatherFormData() {
   //ì´ë¯¸ì§€ ì²˜ë¦¬
  const formData =new FormData();

  //ìˆ«ìì²˜ë¦¬
  // let expVal = document.getElementById('exp').value;
  // if (expVal === '') expVal = 0; 
  const expInput = document.getElementById('exp');
  const expVal = expInput && expInput.value.trim() !=="" ? Number(expInput.value) : 0 ;

  

  //ë‚ ì§œì²˜ë¦¬
  //  const completedAtInput = document.getElementById('completed_at').value;
  //  const completedAt = datetimeToString(completedAtInput);


   //í…ìŠ¤íŠ¸ í•„ë“œ ì¶”ê°€
   formData.append("name", document.getElementById('name').value);
   formData.append("description", document.getElementById('description').value);
   formData.append("complete", document.getElementById('complete').checked);
   //formData.append("completed_at", completedAt);
   formData.append("exp", Number(expVal));
   
   //ì´ë¯¸ì§€ íŒŒì¼ ì¶”ê°€
   const imageInput =document.getElementById('image');
   if(imageInput && imageInput.files.length > 0){  //ì´ë¯¸ì§€ íŒŒì¼ì´ ë§ëŠ”ì§€ ì´ë¯¸ì§€ íŒŒì¼ ê°¯ìˆ˜ > 0 í´ë•Œ
     formData.append('image', imageInput.files[0]); 
   }

   return formData;
}
</script>



<!--
// 5. í¼ ë°ì´í„° ìˆ˜ì§‘: ì…ë ¥ê°’ì„ ê°ì²´ë¡œ ë³€í™˜ 
{% comment %}
function gatherFormData() {
  //ë°ì´í„° í‰íƒ„í™”
  let expVal = document.getElementById('exp').value;
  if (expVal === '') expVal = 0; 
  //íŒŒì´ì¬ input("0")
  // "0" ==0 true  ===false
  //ì˜ˆìƒì¹˜ ëª»í•œ ìë™ ë³€í™˜ ë•Œë¬¸ì— ë²„ê·¸ê°€ ë°œìƒí•  ê°€ëŠ¥ì„ ëŒ€ë¹„í•˜ì—¬  === ì‘ì„±í•©ë‹ˆë‹¤...
  const completedAtInput = document.getElementById('completed_at').value;
  // completedAtInput ê°’ì´ ìˆìœ¼ë©´ -> Date ê°ì²´ë¡œ ë³€í™˜í•´ì„œ ISO í˜•ì‹ ë¬¸ìì—´ë¡œ ë§Œë“¤ê³  ì—†ìœ¼ë©´ null ì„¤ì •í•´ë¼
  // ìë°”ìŠ¤í¬ë¦½íŠ¸ ì‚¼í•­ì—°ì‚°ì

  const completedAt = completedAtInput ? new Date(completedAtInput).toISOString() : null;
  return {
    name:document.getElementById('name').value, // ì´ ê°ì²´ ì•ˆì— nameì´ë¼ëŠ” í‚¤(key) ë¥¼ ë§Œë“¤ê³ ,ê·¸ ê°’(value)ì€ document.getElementById('name').valueë¡œ ì„¤ì •í•´ë¼."
    description:document.getElementById('description').value,
    complete:document.getElementById('complete').checked,
    completed_at: completedAt,
    exp:Number(expVal),
  };
}{% endcomment %}
-->




{% endblock %}    