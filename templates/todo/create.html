{% extends "base.html" %}

{% load static %}

{% block content %}
<div class="container">
	<h2>Create a New Todo</h2>
		<div>
			<label for="name">Name:</label>
			<input type="text" name="name" id="name">
		</div>
		<div>
			<label for="description">Description:</label>
			<textarea name="description" id="description"></textarea>
		</div>
		<div>
			<label for="complete">Complete:</label>
			<input type="checkbox" name="complete" id="complete">
		</div>
    <div>
      <label for="completed_at">Completed At:</label>
      <input type="datetime-local" name="completed_at" id="completed_at">
	  </div>
		<div>
			<label for="exp">Experience Points:</label>
			<input type="number" name="exp" id="exp" min="0">
		</div>
		<button type="submit" id="todoCreate">Create</button>
</div>



<script>
// 1. 문서가 완전히 로드되면 초기화 실행 
document.addEventListener('DOMContentLoaded', init);

// 2. UI 이벤트
function init() {
  bindUIEvents(); // 버튼에 클릭 이벤트 연결
}

// 3. UI 이벤트 바인딩
// 클릭, 스크롤, 탭키 ... 문서로딩...
function bindUIEvents() {
  const btn = document.getElementById('todoCreate');
  if (!btn) return;
  btn.addEventListener('click', onCreateClick); // 클릭 시 4번 실행
}

// 데이터 수집 및 전송
function onCreateClick() {
  //데이터를 폼으로 부터 수집
  const payload = gatherFormData(); 
  //서버에 전송
  createTodo(payload); 
}


// 5. 폼 데이터 수집: 입력값을 객체로 변환 
function gatherFormData() {
  //데이터 평탄화
  let expVal = document.getElementById('exp').value;
  if (expVal === '') expVal = 0; 
  //파이썬 input("0")
  // "0" ==0 true  ===false
  //예상치 못한 자동 변환 때문에 버그가 발생할 가능을 대비하여  === 작성합니다...
  const completedAtInput = document.getElementById('completed_at').value;
  // completedAtInput 값이 있으면 -> Date 객체로 변환해서 ISO 형식 문자열로 만들고 없으면 null 설정해라
  // 자바스크립트 삼항연산자

  const completedAt = completedAtInput ? new Date(completedAtInput).toISOString() : null;
  return {
    name:document.getElementById('name').value, // 이 객체 안에 name이라는 키(key) 를 만들고,그 값(value)은 document.getElementById('name').value로 설정해라."
    description:document.getElementById('description').value,
    complete:document.getElementById('complete').checked,
    completed_at: completedAt,
    exp:Number(expVal),
  };
}


//  6. API 호출: Todo 생성 요청
function createTodo(data) {
  axiosInstance
    .post('/todo/api/create/', data)
    .then(onCreateSuccess) // 7번: 성공 시 처리
    .catch(onCreateError); // 8번: 실패 시 처리
}

//  7. 생성 성공 핸들러: 목록 페이지로 이동 
function onCreateSuccess(response) {
  // 생성 후 목록 페이지로 이동
  window.location.href = '/todo/list/';
}


// --- 8. 생성 실패 핸들러: 에러 알림 --------------------------------------
function onCreateError(error) {
  console.error('Todo 생성 실패:', error);
  alert('Todo 생성에 실패했습니다.');
}
</script>


{% endblock %}    