{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="todoDetail"></div>

<script>
// --- 1. ì´ˆê¸°í™” ---
document.addEventListener("DOMContentLoaded", init);

// ğŸ”§ ì´ˆê¸° ì‹¤í–‰ í•¨ìˆ˜: URLì—ì„œ PK ì¶”ì¶œ í›„ ìƒì„¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
function init(){
    const pk = getTodoId();
    loadTodoIntoDetail(pk);
}

// ğŸ” í˜„ì¬ URLì—ì„œ todo ID(PK) ì¶”ì¶œ
function getTodoId() {
    return window.location.pathname.split('/').filter(Boolean).pop();
}

// ğŸ“¦ ì„œë²„ì—ì„œ íŠ¹ì • Todo ìƒì„¸ ì •ë³´ ë¡œë“œ
function loadTodoIntoDetail(pk) {
    axiosInstance
        .get(`${TODO_API_RETRIEVE_URL}${pk}/`)
        .then(response => {
            renderTodoDetail(response.data);
        })
        .catch(error => {
            console.error('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            alert('í•  ì¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        });
}

// ğŸ–¼ï¸ ìƒì„¸ ì •ë³´ë¥¼ HTMLë¡œ ë Œë”ë§
function renderTodoDetail(todo) {
  const container = document.querySelector(".todoDetail");
  const formattedDate = todo.completed_at ? datetimeToString(todo.completed_at) : "N/A";


   console.log(" todo  ìƒíƒœ : ", todo);


  container.innerHTML = `
    <div class="todo-item">
      <div class="todo-content ${todo?.complete ? "todo-item  completed" :""}">  
            <p><strong>Name:</strong> ${todo.name}</p>
            <p><strong>Description:</strong> ${todo.description}</p>
            <p><strong>Complete:</strong> ${todo.complete ? "Yes" : "No"}</p>
            <p><strong>Completed At:</strong> ${formattedDate}</p>
            <p><strong>Experience Points:</strong> ${todo.exp}</p>
      </div>

    <div class="todo-content-footer">
       <div class="todo-content-footer-sub" >
            <div class="todo-actions">
                <button class="social-btn likeBtn btn" data-id="${todo.id}">
                <span class="icon">${todo.is_liked ? 'ğŸ’”' : 'â¤ï¸'}</span> 
                <span class="count">${todo.like_count}</span>
                </button>

                <button class="bookmarkBtn btn" data-bookmark-id="${todo.id}">
                ğŸ”– <span class="count">${todo.bookmark_count || 0}</span>
                </button>

                <button class="commentToggleBtn btn" data-id="${todo.id}">
                ğŸ’¬ <span class="count">${todo.comments_count || 0}</span>
                </button>
            </div>

            <div>                
                <button class="todoList btn-action">ëª©ë¡ìœ¼ë¡œ</button>        
                <button class="todoUpdate btn-action">ìˆ˜ì •</button>
                <button class="todoDelete btn-action">ì‚­ì œ</button>
                <button class="completeBtn btn-action">ì™„ë£Œ</button>
            </div>

        </div>    

        <div class="commentBox" style="display:none; padding: 10px;">
            <ul class="commentList"></ul>
            <div style="margin-top: 5px; display: flex; gap: 5px;">
            <input type="text" class="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" style="flex: 1; padding: 4px;">
            <button class="commentSubmit">ë“±ë¡</button>
            </div>
        </div>




      </div>


    </div>
  `;

  bindListButton();
  bindCompleteButton(todo.id);
  bindUpdateButton(todo.id);
  bindDeleteButton(todo.id);
  bindDetailEventListeners(todo.id); // ì¢‹ì•„ìš”/ë¶ë§ˆí¬/ëŒ“ê¸€ ë°”ì¸ë”©
}

// âœ…  ì¢‹ì•„ìš”, ë¶ë§ˆí¬, ëŒ“ê¸€ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
function bindDetailEventListeners(todoId) {
  document.querySelector('.likeBtn')?.addEventListener('click', e => {
    e.stopPropagation();
    toggleLike(todoId);
  });

  document.querySelector('.bookmarkBtn')?.addEventListener('click', e => {
    e.stopPropagation();
    toggleBookmark(todoId);
  });

  document.querySelector('.commentToggleBtn')?.addEventListener('click', e => {
    e.stopPropagation();
    const box = document.querySelector('.commentBox');
    box.style.display = (box.style.display === 'none') ? 'block' : 'none';
    loadComments(todoId, box.querySelector('.commentList'));
  });

  document.querySelector('.commentSubmit')?.addEventListener('click', e => {
    e.stopPropagation();
    const input = document.querySelector('.commentInput');
    const content = input.value;
    if (content.trim()) {
      postComment(todoId, content, document.querySelector('.commentList'));
      input.value = '';
    }
  });

  document.querySelector('.commentInput')?.addEventListener('click', e => e.stopPropagation());
}

// âœ…  ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼
function bindListButton() {
  const btn = document.querySelector('.todoList');
  if (!btn) return;
  btn.addEventListener('click', () => {
    window.location.href = `/todo/list/`;
  });
}

// âœ…  ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™ ë²„íŠ¼
function bindUpdateButton(pk) {
  const btn = document.querySelector('.todoUpdate');
  if (!btn) return;
  btn.addEventListener('click', () => {
    window.location.href = `/todo/update/${pk}/`;
  });
}

// âœ…  ì‚­ì œ ì²˜ë¦¬ ë²„íŠ¼
function bindDeleteButton(pk) {
  const btn = document.querySelector('.todoDelete');
  if (!btn) return;
  btn.addEventListener('click', () => {
    if (confirm("ì •ë§ ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      axiosInstance.delete(`${TODO_API_DELETE_URL}${pk}/`)
        .then(() => {
          alert('í•  ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          window.location.href = `/todo/list/`;
        })
        .catch(error => {
          console.error('ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
          alert('í•  ì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }
  });
}

// âœ… ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½ ì²˜ë¦¬ ë²„íŠ¼
function bindCompleteButton(pk) {
  const btn = document.querySelector('.completeBtn');
  if (!btn) return;
  btn.addEventListener('click', () => {
    axiosInstance.patch(`${TODO_API_UPDATE_URL}${pk}/`, { complete: true })
      .then(() => {
        alert('í•  ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.reload();
      })
      .catch(err => console.error('ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:', err));
  });
}
</script>


<script src="{% static 'js/todoCommon.js' %}"></script>


{% endblock %}
